
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.3.9">
    
    
      
        <title>Prefetch Images to EKS nodes - Amazon Containers Blog Maelstrom</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#grab-the-instance-id" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Amazon Containers Blog Maelstrom" class="md-header__button md-logo" aria-label="Amazon Containers Blog Maelstrom" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Amazon Containers Blog Maelstrom
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Prefetch Images to EKS nodes
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-samples/containers-blog-maelstrom" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/containers-blog-maelstrom
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Amazon Containers Blog Maelstrom" class="md-nav__button md-logo" aria-label="Amazon Containers Blog Maelstrom" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Amazon Containers Blog Maelstrom
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-samples/containers-blog-maelstrom" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/containers-blog-maelstrom
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Patterns
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Patterns" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Patterns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aws-cdk-eks-multi-region-skeleton/" class="md-nav__link">
        Multi Region EKS Clusters with CDK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../batch-processing-with-k8s/" class="md-nav__link">
        Batch Processing with K8s
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Prefetch Images to EKS nodes
      </a>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../semantic-versioning-app-runner/" class="md-nav__link">
        Semantic Versioning App Runner
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/aws-samples/containers-blog-maelstrom/edit/master/docs/prefetch-data-to-eks-nodes.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<p>This code is to validate benefits of Event Driven process to prefetch data to EKS Nodes using SSM Automation</p>
<p>Solution Walkthrough</p>
<p>Prerequisites</p>
<p>To run this solution, you must have the following prerequisites:</p>
<ul>
<li>AWS CLI version 2.10 or higher (https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html) to interact with AWS services</li>
<li>eksctl (https://eksctl.io/) for creating and managing your Amazon EKS cluster</li>
<li>kubectl (https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html) for running kubectl commands on your Amazon EKS cluster</li>
<li>envsubst (https://pkg.go.dev/github.com/a8m/envsubst#section-readme) for environment variables substitution for Go.</li>
<li>jq (https://stedolan.github.io/jq/download/) for command-line JSON processing</li>
</ul>
<p>The source code for this blog is available in AWS-Samples on GitHub (https://github.com/aws-samples/containers-blog-maelstrom/tree/main/aws-eks-edp).</p>
<p>Let’s start by setting a few environment variables:</p>
<p>export EDP_AWS_REGION=us-east-1
export EDP_AWS_ACCOUNT=$(aws sts get-caller-identity --query 'Account' --output text)
export EDP_NAME=prefetching-data-automation</p>
<p>Next, lets create Amazon Elastic Container Registry repository for your AWS account :</p>
<p>aws ecr create-repository --cli-input-json file://EDP-Repo.json  --repository-name ${EDP_NAME}</p>
<p>Next, lets create an Amazon EKS Cluster using the below commands. Using envsubst utility we will be replacing the variables in the Yaml Config file and the eksctl CLI tool will deploy the cluster using the EDP-Cluster-Config.yaml file:</p>
<p>envsubst &lt; EDP-Cluster-Config.yaml | eksctl create cluster -f -</p>
<p>Next, Build a large docker image size of approximately 1 GB to test this solution by running shell script EDP-Build-Docker-Image.sh:</p>
<p>./EDP-Build-Docker-Image.sh</p>
<p>we will create prefetching-data-automation-role with trust policy  EDP-Events-Trust-Policy.json which will be assumed by Amazon EventBridge service:</p>
<p>aws iam create-role --role-name $EDP_NAME-role --assume-role-policy-document file://EDP-Events-Trust-Policy.json</p>
<p>we will run the below command to replace variables in EDP-Events-Policy.json policy file by using envsubst utility and attach the policy to the above created `prefetching-data-automation-role :</p>
<p>aws iam put-role-policy --role-name ${EDP_NAME}-role --policy-name ${EDP_NAME}-policy --policy-document "$(envsubst &lt; EDP-Events-Policy.json)"</p>
<p>Next, lets create Amazon EventBridge Rule to trigger SSM Run Command on successful ECR Image push, using envsubst we will be replacing the variables in the EDP-Events-Rule.json:</p>
<p>envsubst &lt; EDP-Events-Rule.json &gt; EDP-Events-Rule-updated.json &amp;&amp; aws events put-rule --cli-input-json file://EDP-Events-Rule-updated.json &amp;&amp; rm EDP-Events-Rule-updated.json</p>
<p>Next, lets Attach the Target as AWS Systems Manager Run Command to AWS EventBridge Rule created above, using envsubst we will be replacing the variables in the EDP-Events-Target.json :</p>
<p>envsubst '$EDP_AWS_REGION $EDP_AWS_ACCOUNT $EDP_NAME' &lt; EDP-Events-Target.json &gt; EDP-Events-Target-updated.json &amp;&amp; aws events put-targets --rule $EDP_NAME --cli-input-json file://EDP-Events-Target-updated.json &amp;&amp; rm EDP-Events-Target-updated.json </p>
<p>Next, lets create AWS Systems Manager State Manager Association for new worker nodes to prefetch container images, using envsubst we will be replacing the variables in the EDP-StateManager-Association.json:</p>
<p>envsubst '$EDP_AWS_REGION $EDP_AWS_ACCOUNT $EDP_NAME' &lt; EDP-StateManager-Association.json &gt; EDP-StateManager-Association-updated.json &amp;&amp; aws ssm create-association --cli-input-json file://EDP-StateManager-Association-updated.json &amp;&amp; rm EDP-StateManager-Association-updated.json</p>
<p>Note: Status might show failed for the AWS SSM State Manager association as there is no image present in ECR yet.</p>
<p>Validation</p>
<p>Now the setup is complete, let’s run some validations on the setup for Event Driven process to prefetch data to EKS Nodes,</p>
<p><em>First test</em> is to verify if the container images are getting fetched to existing worker nodes automatically upon a container image push. </p>
<p>Lets run the following command to get authenticated with ECR repository and push the created container image to Amazon ECR :</p>
<p>aws ecr get-login-password --region $EDP_AWS_REGION | docker login --username AWS --password-stdin $EDP_AWS_ACCOUNT.dkr.ecr.$EDP_AWS_REGION.amazonaws.com</p>
<p>docker push $EDP_AWS_ACCOUNT.dkr.ecr.$EDP_AWS_REGION.amazonaws.com/$EDP_NAME</p>
<p>Now lets check if the event rule we created on the Amazon EventBridge has been triggered. In your Amazon EventBridge console, Navigate to <em>TriggeredRules</em> under <em>Monitoring</em> tab. If there are no <em>FailedInvocations</em> datapoints, then EventBridge has delivered the event to the target successfully which in this case is AWS Systems Manager Run Command (Note: It might take 3 to 5 mins for the data points to be published in the Monitoring graphs)
[Image: Image.jpg]Next lets verify if AWS Systems Manager Run Command is triggered by Amazon EventBridge. Run the below command to see the invocations. Look for DocumentName which should be AWS-RunShellScript, RequestedDateTime to identify corresponding run, and then status to make sure if the Run Command executed Successfully or not.</p>
<blockquote>
<p>aws ssm list-command-invocations --details --filter "[{\"key\": \"DocumentName\", \"value\": \"arn:aws:ssm:us-east-1::document/AWS-RunShellScript\"}]"</p>
</blockquote>
<p>Output:</p>
<p>{
    "CommandInvocations": [
        {
            "CommandId": "eeb9d869-421d-488f-b1ba-ce93a69db2b0",
            "InstanceId": "i-0e1a4977c389<strong>*</strong>",
            "InstanceName": "ip-192-168-29-214.ec2.internal",
            "Comment": "",
            "DocumentName": "arn:aws:ssm:us-east-1::document/AWS-RunShellScript",
            "DocumentVersion": "$DEFAULT",
            "RequestedDateTime": "2023-02-17T17:35:48.520000-06:00",
            "Status": "Success",
            "StatusDetails": "Success",
            .......
            .......</p>
<p>Next, lets verify if the Image has been copied in to worker node of your Amazon EKS Cluster using the below command:</p>
<blockquote>
<p>aws ec2 describe-instances \
--filters "Name=tag:eks:cluster-name,Values=$EDP_NAME" "Name=tag:eks:nodegroup-name,Values=nodegroup" \
--query "Reservations[<em>].Instances[</em>].InstanceId" \
--output text | xargs -I {} aws ssm start-session \
    --target {} \
    --document-name AWS-StartInteractiveCommand \
    --parameters "command=echo \$(curl -s http://169.254.169.254/latest/meta-data/instance-id) &amp;&amp; sudo docker images" \
    --region $EDP_AWS_REGION</p>
</blockquote>
<p>Output:</p>
<p>Starting session with SessionId: nbbat-0cf87cdf534<strong><em>*</em>
........
REPOSITORY                                                                 TAG                  IMAGE ID       CREATED          SIZE
0266528</strong>***.dkr.ecr.us-east-1.amazonaws.com/prefetching-data-automation   latest               d50f7ccece64   50 minutes ago   1.23GB
.......</p>
<p><em>Second Test</em> is to validate the container image getting copied to new worker node for any newly added Amazon EKS worker node</p>
<p>Lets create new worker node as part of EKS Cluster using below command :</p>
<p>eksctl scale nodegroup --cluster $EDP_NAME --name nodegroup --nodes 2 --nodes-min 1 --nodes-max 3</p>
<p>Next, lets verify if the AWS System Manager State Manager Association has been triggered and association execution is successful. Note: Please wait for for few minutes for new worker node to come up and run below command</p>
<p>aws ssm list-associations \
--association-filter-list "key=AssociationName,value=$EDP_NAME"</p>
<p>Output:</p>
<p>{
    "Associations": [
        {
            "Name": "AWS-RunShellScript",
            "AssociationId": "d9c82d84-0ceb-4f0f-a8d8-35cd67d1a66e",
......
                "AssociationStatusAggregatedCount": {
                    "Failed": 1,
                    "Success": 1
                }
            },
            "AssociationName": "prefetching-data-automation"
        }
    ]
}</p>
<p>Next, lets verify if the Image has been copied in to worker node of your Amazon EKS Cluster using the below command:</p>
<p>aws ec2 describe-instances \
--filters "Name=tag:eks:cluster-name,Values=$EDP_NAME" "Name=tag:eks:nodegroup-name,Values=nodegroup" \
--query "Reservations[<em>].Instances[</em>].InstanceId" \
--output text | xargs -I {} aws ssm start-session \
    --target {} \
    --document-name AWS-StartInteractiveCommand \
    --parameters "command=echo \$(curl -s http://169.254.169.254/latest/meta-data/instance-id) &amp;&amp; sudo docker images" \
    --region $EDP_AWS_REGION</p>
<p>Output:</p>
<p>Starting session with SessionId: nbbat-0cf87cdf5347<strong><em>*</em>
........
REPOSITORY                                                                 TAG                  IMAGE ID       CREATED          SIZE
0266528</strong>***.dkr.ecr.us-east-1.amazonaws.com/prefetching-data-automation   latest               d50f7ccece64   50 minutes ago   1.23GB
.......</p>
<p><em>Final Test</em> is identify the time difference for a Kubernetes pod to get to running with a Container Image pulled from Amazon ECR vs Image pulled locally</p>
<p><em>Final Test A</em></p>
<p>Delete the locally cached/copied image from one of the worker nodes using the following commands</p>
<h1 id="grab-the-instance-id">Grab the instance ID<a class="headerlink" href="#grab-the-instance-id" title="Permanent link">&para;</a></h1>
<p>InstanceID=$(kubectl get nodes -o jsonpath='{.items[*].spec.providerID}' | awk -F/ '{print $NF}')</p>
<h1 id="ssh-to-the-instance">SSH to the instance<a class="headerlink" href="#ssh-to-the-instance" title="Permanent link">&para;</a></h1>
<p>aws ssm start-session \
    --target $InstanceID \
    --region $EDP_AWS_REGION</p>
<h1 id="list-the-locally-cached-image-that-you-pushed-in-one-of-the-above-step">List the locally cached image that you pushed in one of the above step<a class="headerlink" href="#list-the-locally-cached-image-that-you-pushed-in-one-of-the-above-step" title="Permanent link">&para;</a></h1>
<p>sudo su
docker images</p>
<h1 id="delete-the-locally-cached-images">Delete the locally cached images<a class="headerlink" href="#delete-the-locally-cached-images" title="Permanent link">&para;</a></h1>
<p>docker rmi <docker image id identified above></p>
<p>Exit out of the SSM session</p>
<p>Next, lets pull the latest container image and create a Kubernetes Pod :</p>
<p>sh EDP_Pod.sh</p>
<p>kubectl apply -f EDP-Pod.yaml </p>
<p>Now lets run below command to check how long it took for pod to get in to running state</p>
<p>kubectl describe pod $EDP_NAME</p>
<p>Output:</p>
<p>nbbathul@88665a1f8bb5 EDP_Working % kubectl describe pod prefetching-data-automation
Name:         prefetching-data-automation
Namespace:    default
Priority:     0
Node:         ip-192-168-19-136.ec2.internal/192.168.19.136
Start Time:   Thu, 09 Mar 2023 23:03:52 -0600
Labels:       <none>
Annotations:  kubernetes.io/psp: eks.privileged
Status:       Running
IP:           192.168.23.89
IPs:
  IP:  192.168.23.89
Containers:
  prefetching-data-automation:
    Container ID:  containerd://29579b61aaca8597bade857458e95b669ab7fca142c1e8f733cfec07d15d9d4d
    Image:         022435809194.dkr.ecr.us-east-1.amazonaws.com/prefetching-data-automation:latest
    Image ID:      022435809194.dkr.ecr.us-east-1.amazonaws.com/prefetching-data-automation@sha256:d7a93473bd682ed53acbaba18405532e6c1026c35b7d04ffc96ad89d2221736c
    Port:          <none>
    Host Port:     <none>
    Command:
      sleep
      3600
    State:          Running
      Started:      Thu, 09 Mar 2023 23:04:52 -0600
    Ready:          True
    Restart Count:  0
    Environment:    <none></p>
<p>Next, lets also validate time take by pod to get in to running state by running below commands</p>
<p>chmod +x EDP-Get-Pod-Boot-Time.sh</p>
<p>for pod in $(kubectl get --no-headers=true pods -o name | awk -F "/" '{print $2}'); do ./EDP-Get-Pod-Boot-Time.sh $pod ; done &gt;&gt; EDP-Pod-Up-Time-With-Image-From-ECR.txt</p>
<p>cat EDP-Pod-Up-Time-With-Image-From-ECR.txt</p>
<p>Output :</p>
<p>It took 60 seconds for test to boot up</p>
<p><em>Final Test B</em></p>
<p>Next, delete the Kubernetes Pod, create another pod by using sample pod definition file created in above and calculated the time it took to get to running state, since the image is cached locally this time it shouldn’t take long to start the pod :</p>
<p>kubectl delete pod $EDP_NAME
kubectl apply -f EDP-Pod.yaml </p>
<p>Now lets run below command to check how long it took for pod to get in to running state</p>
<p>kubectl describe pod $EDP_NAME</p>
<p>Output:</p>
<p>nbbathul@88665a1f8bb5 EDP_Working % kubectl describe pod prefetching-data-automation                                                                                                                      <br />
Name:         prefetching-data-automation
Namespace:    default
Priority:     0
Node:         ip-192-168-19-136.ec2.internal/192.168.19.136
Start Time:   Thu, 09 Mar 2023 23:20:05 -0600
Labels:       <none>
Annotations:  kubernetes.io/psp: eks.privileged
Status:       Running
IP:           192.168.10.39
IPs:
  IP:  192.168.10.39
Containers:
  prefetching-data-automation:
    Container ID:  containerd://fc06a2c5f5ee7734b2a9c4fd893acd1aca7c314ba035b6a01fa9954ae48a69fb
    Image:         022435809194.dkr.ecr.us-east-1.amazonaws.com/prefetching-data-automation:latest
    Image ID:      022435809194.dkr.ecr.us-east-1.amazonaws.com/prefetching-data-automation@sha256:d7a93473bd682ed53acbaba18405532e6c1026c35b7d04ffc96ad89d2221736c
    Port:          <none>
    Host Port:     <none>
    Command:
      sleep
      3600
    State:          Running
      Started:      Thu, 09 Mar 2023 23:20:06 -0600
    Ready:          True
    Restart Count:  0
    Environment:    <none></p>
<p>Next, lets also validate time take by pod to get in to running state by running below commands</p>
<p>for pod in $(kubectl get --no-headers=true pods -o name | awk -F "/" '{print $2}'); do ./EDP-Get-Pod-Boot-Time.sh $pod ; done &gt;&gt; EDP-Pod-Up-Time-With-Image-From-Workernode.txt</p>
<p>cat EDP-Pod-Up-Time-With-Image-From-Workernode.txt</p>
<p>Output:</p>
<p>It took 1 second for test to boot up</p>
<p>Below table shows  time it took for Pod that has been created with locally cached image is drastically less when compared to Pod that has been created with image that got pulled from ECR repository.</p>
<div class="highlight"><pre><span></span><code>Final Test A    Final Test B
</code></pre></div>
<p>Pod Start Time  23:03:52 -0600  23:20:05 -0600
Pod Running Time    23:04:52 -0600  23:20:06 -0600
Total Time Taken    60 Seconds  1 Second</p>
<p>Final Test A: Created Pod by pulling image from ECR repo
Final Test B: Created Pod by pulling locally cached Image</p>
<p>Cleanup</p>
<p>chmod +x EDP-Cleanup.sh</p>
<p>./EDP-Cleanup.sh</p>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../batch-processing-with-k8s/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Batch Processing with K8s" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Batch Processing with K8s
            </div>
          </div>
        </a>
      
      
        
        <a href="../semantic-versioning-app-runner/" class="md-footer__link md-footer__link--next" aria-label="Next: Semantic Versioning App Runner" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Semantic Versioning App Runner
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["tabs"], "search": "../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>