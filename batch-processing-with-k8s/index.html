
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.3.9">
    
    
      
        <title>Batch Processing with K8s - Amazon Containers Blog Maelstrom</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#batch-processing-in-scale-using-k8s-jobs-and-step-functions" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Amazon Containers Blog Maelstrom" class="md-header__button md-logo" aria-label="Amazon Containers Blog Maelstrom" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Amazon Containers Blog Maelstrom
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Batch Processing with K8s
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-samples/containers-blog-maelstrom" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/containers-blog-maelstrom
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Amazon Containers Blog Maelstrom" class="md-nav__button md-logo" aria-label="Amazon Containers Blog Maelstrom" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Amazon Containers Blog Maelstrom
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-samples/containers-blog-maelstrom" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/containers-blog-maelstrom
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Patterns
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Patterns" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Patterns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../aws-cdk-eks-multi-region-skeleton/" class="md-nav__link">
        Multi Region EKS Clusters with CDK
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Batch Processing with K8s
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Batch Processing with K8s
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution-overview" class="md-nav__link">
    Solution overview
  </a>
  
    <nav class="md-nav" aria-label="Solution overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-services" class="md-nav__link">
    AWS Services
  </a>
  
    <nav class="md-nav" aria-label="AWS Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-step-function" class="md-nav__link">
    AWS Step function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-job" class="md-nav__link">
    Kubernetes Job
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sample-application" class="md-nav__link">
    Sample application
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-and-deployment" class="md-nav__link">
    Build and Deployment
  </a>
  
    <nav class="md-nav" aria-label="Build and Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pre-requistes" class="md-nav__link">
    Pre-requistes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build" class="md-nav__link">
    Build
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy" class="md-nav__link">
    Deploy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-testing" class="md-nav__link">
    Unit testing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-test" class="md-nav__link">
    Integration test
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-testing" class="md-nav__link">
    Performance testing
  </a>
  
    <nav class="md-nav" aria-label="Performance testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#results" class="md-nav__link">
    Results
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    Cleanup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    Resources
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../prefetch-data-to-eks-nodes/" class="md-nav__link">
        Prefetch Images to EKS nodes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../semantic-versioning-app-runner/" class="md-nav__link">
        Semantic Versioning App Runner
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution-overview" class="md-nav__link">
    Solution overview
  </a>
  
    <nav class="md-nav" aria-label="Solution overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-services" class="md-nav__link">
    AWS Services
  </a>
  
    <nav class="md-nav" aria-label="AWS Services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-step-function" class="md-nav__link">
    AWS Step function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kubernetes-job" class="md-nav__link">
    Kubernetes Job
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sample-application" class="md-nav__link">
    Sample application
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-and-deployment" class="md-nav__link">
    Build and Deployment
  </a>
  
    <nav class="md-nav" aria-label="Build and Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pre-requistes" class="md-nav__link">
    Pre-requistes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build" class="md-nav__link">
    Build
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy" class="md-nav__link">
    Deploy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-testing" class="md-nav__link">
    Unit testing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-test" class="md-nav__link">
    Integration test
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performance-testing" class="md-nav__link">
    Performance testing
  </a>
  
    <nav class="md-nav" aria-label="Performance testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#results" class="md-nav__link">
    Results
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    Cleanup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" class="md-nav__link">
    Resources
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/aws-samples/containers-blog-maelstrom/edit/master/docs/batch-processing-with-k8s.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="batch-processing-in-scale-using-k8s-jobs-and-step-functions">Batch processing in scale using K8s jobs and step functions<a class="headerlink" href="#batch-processing-in-scale-using-k8s-jobs-and-step-functions" title="Permanent link">&para;</a></h1>
<p>This article talks about an approach that can help customers scale large file processing workloads in AWS EKS using Kubernetes jobs and AWS step functions.</p>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>This approach uses AWS step functions to orchestrate the end to end flow, which involves:</p>
<ul>
<li>Reading of the input file from AWS S3</li>
<li>Splitting the large input file into smaller files, processing it, saving the data into a database</li>
<li>Writing the output file to AWS S3</li>
</ul>
<p>Before we get into the implementation details, let us discuss the alternative approach to address the same use case.</p>
<ul>
<li>Sequential read (aka single-threaded) - This approach uses a simple file reader that reads the large file row by row and processes it.</li>
<li>Big data system (using spark) - This approach is quite popular and commonly implemented when it comes to processing large files. It uses spark api's like <code>spark.csv.read()</code> to read the file, convert them into dataframes or RDD, process them and write the data back into to a data lake as CSV, txt or parquet files</li>
<li>Stream-based system (using message bus) - In this approach, a program reads the file row by row and pushes the records as individual messages to a message bus (like <code>Kafka</code> or <code>AWS Kinesis streams</code>). A consumer (like AWS Lambda)  reads the message, processes it, and stores the result in a file system or database</li>
</ul>
<blockquote>
<p>Note: Let us assume a large file, in this case, refers to a file with at least one million records, delimited by line breaks (with each row presenting a single record)</p>
</blockquote>
<p>Here is a relative comparison of these approaches:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
<th>Sequential read (#1)</th>
<th>Big data system (#2)</th>
<th>Stream-based system (#3)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Row order</td>
<td>Can the output file be generated in the same row order as input file</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>Horizontal scaling</td>
<td>Will horizontal scaling help?</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>Vertical scaling</td>
<td>Will vertical scaling help?</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>Processing time</td>
<td>Time taken to process a large file</td>
<td>Relatively slow</td>
<td>Faster than option #1</td>
<td>Faster than option #1</td>
</tr>
<tr>
<td>Level of refactor</td>
<td>Percentage of refactoring required in moving an existing codebase</td>
<td>30% to 40%</td>
<td>80% to 90%</td>
<td>60% to 70%</td>
</tr>
</tbody>
</table>
<p>Each of these approaches has its advantages (like scaling, elasticity) and disadvantages (like maintaining row order, level of refactoring involved) when comparing with one another. So part of this article, let us see how we can implement an hybrid approach that can provide scalability, elasticity, and still maintain the row order in the output file with an acceptable (30% to 40%) level of refactoring.</p>
<h2 id="solution-overview">Solution overview<a class="headerlink" href="#solution-overview" title="Permanent link">&para;</a></h2>
<h3 id="aws-services">AWS Services<a class="headerlink" href="#aws-services" title="Permanent link">&para;</a></h3>
<p><code>AWS Step function</code> and <code>Kubernetes Job</code> are the two essential technologies used to implement this approach, and here is a high level overview of them.</p>
<h4 id="aws-step-function">AWS Step function<a class="headerlink" href="#aws-step-function" title="Permanent link">&para;</a></h4>
<p>AWS Step Functions is a serverless function orchestrator that makes it easy to sequence AWS Lambda functions and multiple AWS services into business-critical applications. Through its visual interface, you can create and run a series of checkpointed and event-driven workflows that maintain the application state. Read more about it <a href="https://aws.amazon.com/step-functions">here</a></p>
<h4 id="kubernetes-job">Kubernetes Job<a class="headerlink" href="#kubernetes-job" title="Permanent link">&para;</a></h4>
<p>A Job creates one or more Pods and will continue to retry execution of the Pods until a specified number of them successfully terminate. As pods complete, the job tracks the successful completions. When a specified number of successful completions is reached, the task (ie, job) is done. Read more about it <a href="https://kubernetes.io/docs/concepts/workloads/controllers/job/">here</a></p>
<h3 id="sample-application">Sample application<a class="headerlink" href="#sample-application" title="Permanent link">&para;</a></h3>
<p>To demonstrate this approach, we have implemented a sample application that can take in an input file, process it, save the data in <code>Dynamodb</code> and write the output file to <code>AWS S3</code>. The below image shows the high-level architecture of the application:</p>
<p><img alt="arch" src="images/arch.svg" /></p>
<p>Here is the end to end flow of the application:</p>
<p><code>AWS Step function</code> is invoked when the input file gets dropped into the <code>AWS S3</code> bucket. <code>AWS Cloudtrail</code> listens to all the write events of the input S3 bucket. <code>AWS Step functions</code> will execute the below steps, part of file processing:</p>
<ol>
<li><code>File splitter</code> - Kubernetes job will read the input file from S3.</li>
<li><code>File splitter</code> will split the large input file into smaller files and writes them to the <code>Elastic file system</code> mounted on the pod. The program uses the Unix <code>split</code> command to chunk the large files into smaller ones, with each file containing a maximum of <code>MAX_LINES_PER_BATCH</code> lines, set in the environment variable, defaults to 30000.</li>
<li>Save the path of the split files in <code>AWS Elastic cache</code> (Redis) that will get used in tracking the overall progress of this job. The data in Redis cache gets stored in this format:
    | Format  | Data type | Sample data |
    | ----- | ------------- | ----- |
    | <Key, value> | &lt;string, set\&lt;string>> | &lt;CloudTrail_Event_Id, Set\&lt;\&lt;EFS_Path_Of_SplitFiles>> |</li>
<li><code>Split-file-lambda</code> - Lambda function will read the Redis cache and return an array of split file locations as response</li>
<li><code>Map state</code> will use the split files array as input and create parallel Kubernetes jobs to process all these split files in parallel, with an <code>MaxConcurrency = 0</code>. Each job will receive one split file as input and takes care of the following:<ul>
<li>Read the split file from the EFS location</li>
<li>Process each row, generate <code>ConfirmationId</code> for <code>OrderId</code> field available in the input. Save the information in <code>AWS Dynamodb</code> under <code>Orders</code> table. All dynamodb writes are batched to a maximum of 25 rows per request.</li>
<li>Part of this process, a CSV file gets created in EFS location with each row containing both <code>ConfirmationId</code> and <code>OrderId</code>, written in batch</li>
<li>Updates elastic cache by removing <code>split file (path)</code> from Redis set using <code>rdb.SRem</code> command</li>
<li>If the set associated with the <code>CloudTrail_Event_Id</code> is empty, then all the parallel file processing jobs are complete. So we can merge the output split files in the EFS directory and upload them to the S3 bucket</li>
</ul>
</li>
</ol>
<blockquote>
<p>Note: Itâ€™s very important to settle on a right value for the maximum number of rows a split input file can contain. We set this value via <code>MAX_LINES_PER_BATCH</code> environment variable. Giving a smaller value will end up with too many split files causing too many containers to get created, and setting a large value will leaves too little scope for parallelism.</p>
</blockquote>
<p>Below are the snapshots of various artifacts used in this flow</p>
<p><strong>Input file:</strong></p>
<table>
<thead>
<tr>
<th>Region</th>
<th>Country</th>
<th>Item Type</th>
<th>Sales Channel</th>
<th>Order Priority</th>
<th>Order Date</th>
<th>Order ID</th>
<th>Ship Date</th>
<th>Units Sold</th>
<th>Unit Price</th>
<th>Unit Cost</th>
<th>Total Revenue</th>
<th>Total Cost</th>
<th>Total Profit</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sub-Saharan Africa</td>
<td>South Africa</td>
<td>Fruits</td>
<td>Offline</td>
<td>M</td>
<td>7/27/2012</td>
<td>791862618</td>
<td>7/28/2012</td>
<td>1593</td>
<td>9.33</td>
<td>6.92</td>
<td>14862.69</td>
<td>11023.56</td>
<td>3839.13</td>
</tr>
</tbody>
</table>
<p><strong>Output file:</strong></p>
<p>791862618,aefa3585-7f46-476e-bc22-70181704c240</p>
<p><strong>Orders (Dynamodb table):</strong></p>
<table>
<thead>
<tr>
<th>Region</th>
<th>Country</th>
<th>Item Type</th>
<th>Sales Channel</th>
<th>Order Priority</th>
<th>Order Date</th>
<th>Order ID</th>
<th>Ship Date</th>
<th>Units Sold</th>
<th>Unit Price</th>
<th>Unit Cost</th>
<th>Total Revenue</th>
<th>Total Cost</th>
<th>Total Profit</th>
<th>ConfirmationId</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sub-Saharan Africa</td>
<td>South Africa</td>
<td>Fruits</td>
<td>Offline</td>
<td>M</td>
<td>7/27/2012</td>
<td>791862618</td>
<td>7/28/2012</td>
<td>1593</td>
<td>9.33</td>
<td>6.92</td>
<td>14862.69</td>
<td>11023.56</td>
<td>3839.13</td>
<td>aefa3585-7f46-476e-bc22-70181704c240</td>
</tr>
</tbody>
</table>
<h2 id="build-and-deployment">Build and Deployment<a class="headerlink" href="#build-and-deployment" title="Permanent link">&para;</a></h2>
<h3 id="pre-requistes">Pre-requistes<a class="headerlink" href="#pre-requistes" title="Permanent link">&para;</a></h3>
<ul>
<li>AWS CDK should be installed in the local laptop. You can read more about it <a href="https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html">here</a></li>
<li><code>Yarn</code> needs to be installed, you can check the installation status by running this command</li>
<li>An AWS account with console and API access</li>
<li>Docker desktop needs to be installed in the local laptop, you can read more about it <a href="https://www.docker.com/products/docker-desktop">here</a></li>
</ul>
<div class="highlight"><pre><span></span><code>yarn version
</code></pre></div>
<p><strong>Output</strong>
1.22.10</p>
<p>If <code>Yarn</code> is not installed, run the following command</p>
<div class="highlight"><pre><span></span><code>npm install -g yarn
</code></pre></div>
<h3 id="build">Build<a class="headerlink" href="#build" title="Permanent link">&para;</a></h3>
<p>Check out the code from this repository using this command:</p>
<div class="highlight"><pre><span></span><code>mkdir batch-processing-with-k8s <span class="o">&amp;&amp;</span> <span class="nb">cd</span> batch-processing-with-k8s
git clone git@ssh.gitlab.aws.dev:am3-app-modernization-gsp/eks/batch-processing-with-k8s.git .
</code></pre></div>
<blockquote>
<p>Note: Source code for all Kubernetes jobs and lambda functions are available under <a href="src">src</a> folder</p>
</blockquote>
<h3 id="deploy">Deploy<a class="headerlink" href="#deploy" title="Permanent link">&para;</a></h3>
<p>Code for the sample application using this CDK construct is available in <code>src/integ.default.ts</code>. In order to deploy the application, first bootstrap a CDK environment (if you haven't done so already).</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Bootstrap CDK (ONLY ONCE, if you have already done this you can skip this part)</span>
<span class="c1"># Subsitute your AWS Account Id and AWS region in the command below</span>
cdk bootstrap <span class="se">\</span>
    --cloudformation-execution-policies arn:aws:iam::aws:policy/AdministratorAccess <span class="se">\</span>
    aws://&lt;AWS Account Id&gt;/&lt;AWS_REGION&gt;
</code></pre></div>
<p>The code is created as a CDK construct, the following parameters can be customized as part of the deployment</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>vpc</td>
<td>VPC in which the resources needs to be created</td>
<td>New VPC will be created</td>
</tr>
<tr>
<td>minNodes</td>
<td>Autoscaling parameter for minimum value for EKS worker nodes</td>
<td>5</td>
</tr>
<tr>
<td>desiredNodes</td>
<td>Autoscaling parameter for desired value for EKS worker nodes</td>
<td>5</td>
</tr>
<tr>
<td>maxNodes</td>
<td>Autoscaling parameter for maximum value for EKS worker nodes</td>
<td>5</td>
</tr>
<tr>
<td>inputBucket</td>
<td>S3 bucket, where the input files will get dropped</td>
<td>input-bucket</td>
</tr>
<tr>
<td>maxSplitLines</td>
<td>Maximum number of records per split input file</td>
<td>30000</td>
</tr>
</tbody>
</table>
<p>Run the following command to start the deployment</p>
<div class="highlight"><pre><span></span><code>cdk deploy --require-approval never
</code></pre></div>
<p>Once the deployment is successful, you will see the following output:</p>
<div class="highlight"><pre><span></span><code> âœ…  file-batch-stack

Outputs:
file-batch-stack.KubernetesFileBatchConstructInputBucketName610D8598 <span class="o">=</span> file-batch-stack-kubernetesfilebatchconstructinpu-1u3xbu9ycgorp
file-batch-stack.KubernetesFileBatchConstructMultithreadedstepfuctionF3358A99 <span class="o">=</span> KubernetesFileBatchConstructfilebatchmultithreaded0B80AF5A-abBRhxEtxLig
file-batch-stack.KubernetesFileBatchConstructfilebatchEFSFileSystemId9139F216 <span class="o">=</span> fs-696fb5dd
file-batch-stack.KubernetesFileBatchConstructfilebatcheksclusterClusterName146E1BCB <span class="o">=</span> KubernetesFileBatchConstructfilebatchekscluster6B334C7D-7874a48b84604e20a0dc68ecd3715e27
file-batch-stack.KubernetesFileBatchConstructfilebatcheksclusterConfigCommand3063A155 <span class="o">=</span> aws eks update-kubeconfig --name KubernetesFileBatchConstructfilebatchekscluster6B334C7D-7874a48b84604e20a0dc68ecd3715e27 --region us-east-1 --role-arn arn:aws:iam::775492342640:role/file-batch-stack-KubernetesFileBatchConstructfileb-146I0AN7L7JXW
file-batch-stack.KubernetesFileBatchConstructfilebatcheksclusterGetTokenCommandAD6928E0 <span class="o">=</span> aws eks get-token --cluster-name KubernetesFileBatchConstructfilebatchekscluster6B334C7D-7874a48b84604e20a0dc68ecd3715e27 --region us-east-1 --role-arn arn:aws:iam::775492342640:role/file-batch-stack-KubernetesFileBatchConstructfileb-146I0AN7L7JXW
file-batch-stack.KubernetesFileBatchConstructfilebatcheksclusterMastersRoleArn52BC348E <span class="o">=</span> arn:aws:iam::775492342640:role/file-batch-stack-KubernetesFileBatchConstructfileb-146I0AN7L7JXW

Stack ARN:
arn:aws:cloudformation:us-east-1:775492342640:stack/file-batch-stack/886208f0-aeb2-11eb-9592-0e4dccb471bf
</code></pre></div>
<blockquote>
<p><strong>Note:</strong> Make sure to run the <code>ClusterConfig</code> command available part of the CDK output. CDK script will add the newly created AWS EKS cluster to the kubeconfig to run kubectl command using this.</p>
</blockquote>
<p>The deployment will take care of building the docker images for all the k8s jobs, lambda functions and uploading it to <code>AWS ECR</code></p>
<h2 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h2>
<h3 id="unit-testing">Unit testing<a class="headerlink" href="#unit-testing" title="Permanent link">&para;</a></h3>
<p>Unit testcases can be executed by running the following command from the root directory</p>
<div class="highlight"><pre><span></span><code>yarn <span class="nb">test</span>

yarn run v1.22.10
$ npx projen <span class="nb">test</span>
ðŸ¤– <span class="nb">test</span> <span class="p">|</span> rm -fr lib/
ðŸ¤– <span class="nb">test</span> Â» test:compile <span class="p">|</span> tsc --noEmit --project tsconfig.jest.json
ðŸ¤– <span class="nb">test</span> <span class="p">|</span> jest --passWithNoTests --all --updateSnapshot
 PASS  test/index.test.ts <span class="o">(</span><span class="m">7</span>.722 s<span class="o">)</span>
  âœ“ create app <span class="o">(</span><span class="m">3181</span> ms<span class="o">)</span>

----------<span class="p">|</span>---------<span class="p">|</span>----------<span class="p">|</span>---------<span class="p">|</span>---------<span class="p">|</span>-------------------
File      <span class="p">|</span> % Stmts <span class="p">|</span> % Branch <span class="p">|</span> % Funcs <span class="p">|</span> % Lines <span class="p">|</span> Uncovered Line <span class="c1">#s</span>
----------<span class="p">|</span>---------<span class="p">|</span>----------<span class="p">|</span>---------<span class="p">|</span>---------<span class="p">|</span>-------------------
All files <span class="p">|</span>   <span class="m">95</span>.95 <span class="p">|</span>       <span class="m">75</span> <span class="p">|</span>   <span class="m">85</span>.71 <span class="p">|</span>   <span class="m">95</span>.95 <span class="p">|</span>
 index.ts <span class="p">|</span>   <span class="m">95</span>.95 <span class="p">|</span>       <span class="m">75</span> <span class="p">|</span>   <span class="m">85</span>.71 <span class="p">|</span>   <span class="m">95</span>.95 <span class="p">|</span> <span class="m">558</span>-642
----------<span class="p">|</span>---------<span class="p">|</span>----------<span class="p">|</span>---------<span class="p">|</span>---------<span class="p">|</span>-------------------
Test Suites: <span class="m">1</span> passed, <span class="m">1</span> total
Tests:       <span class="m">1</span> passed, <span class="m">1</span> total
Snapshots:   <span class="m">0</span> total
Time:        <span class="m">8</span>.56 s
Ran all <span class="nb">test</span> suites.
ðŸ¤– <span class="nb">test</span> Â» eslint <span class="p">|</span> eslint --ext .ts,.tsx --fix --no-error-on-unmatched-pattern src <span class="nb">test</span> build-tools .projenrc.js
âœ¨  Done <span class="k">in</span> <span class="m">24</span>.16s.
</code></pre></div>
<h3 id="integration-test">Integration test<a class="headerlink" href="#integration-test" title="Permanent link">&para;</a></h3>
<p>Lets run a simple end to end integration test using a simple input file <a href="payload\test.csv">test.csv</a> under payload folder. Run the following command from the root directory:</p>
<div class="highlight"><pre><span></span><code>&gt; aws s3api put-object --bucket &lt;&lt;input_bucket&gt;&gt; --key test.csv --body payload/test.csv
</code></pre></div>
<blockquote>
<p>Note: Replace <code>input_bucket</code> with the actual input bucket available part of the CDK output</p>
</blockquote>
<p><strong>Output</strong></p>
<div class="highlight"><pre><span></span><code><span class="o">{</span>
    <span class="s2">&quot;ETag&quot;</span>: <span class="s2">&quot;\&quot;3ff3c83af2553279cd0f6f8fcf59980a\&quot;&quot;</span>
<span class="o">}</span>
</code></pre></div>
<p>Now the step function should get automatically triggered and see the updates in the execution details page. Navigate to the state machine <a href="https://console.aws.amazon.com/states/home?region=us-east-1#/statemachines">homepage</a> and select the state machine created by the CDK (available part of the CDK output). </p>
<p>The step function should successfully get executed, and it should look like below in the execution details page:</p>
<p><img alt="state-machine" src="images/state-machine.png" /></p>
<p>The response file can be downloaded by running the following command:</p>
<div class="highlight"><pre><span></span><code>aws s3 cp s3://&lt;&lt;input_bucket&gt;&gt;/test.csv_Output .
</code></pre></div>
<blockquote>
<p>Note: Replace <code>input_bucket</code> with the actual input bucket available part of the CDK output</p>
</blockquote>
<p><strong>Output</strong></p>
<div class="highlight"><pre><span></span><code>download: s3://<span class="s">&lt;&lt;input_bucket&gt;&gt;/test.csv_Sin</span>gle_Output to ./test.csv_Single_Output
</code></pre></div>
<h3 id="performance-testing">Performance testing<a class="headerlink" href="#performance-testing" title="Permanent link">&para;</a></h3>
<ul>
<li>Letâ€™s run some performance tests with different datasets varying from 200 rows to 2 million rows and see how the system behaves in scaling up and processing these files quicker.</li>
<li>To represent the "Sequential read (aka single-threaded)" approach, we created a step function with just one step calling Kubernetes job, which takes care of reading the input file, processing it, saving the data in dynamodb, and uploading the output file to AWS S3.</li>
<li>Code to create this step function is available part of the CDK <a href="src\index.ts">index.ts</a>. To create this step function uncomment lines from 187 to 193, comment everything from 178 to 184 and then run <code>cdk deploy --require-approval never</code>. This will delete the multi-threaded step function (enabled with map construct) and create the single-threaded one</li>
</ul>
<h4 id="results">Results<a class="headerlink" href="#results" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>File</th>
<th>Records</th>
<th>Sequential read</th>
<th>Parallel (map)</th>
</tr>
</thead>
<tbody>
<tr>
<td>test.csv</td>
<td>200</td>
<td>68 seconds</td>
<td>117 seconds</td>
</tr>
<tr>
<td>data.csv</td>
<td>1 Million</td>
<td>545 seconds</td>
<td>189 seconds</td>
</tr>
<tr>
<td>data2M.csv</td>
<td>2 Million</td>
<td>1194 seconds</td>
<td>243 seconds</td>
</tr>
</tbody>
</table>
<p>Once we plot the numbers in a chart, here is how it looks like:</p>
<p><img alt="chart" src="images/chart.png" /></p>
<p>As the load grows, we can see the "Parallel (map)" approach scales better compared to the "Sequential read" model.</p>
<blockquote>
<p>Note: All the payloads used in running these tests are available part of the <a href="payload">payload</a> folder in the root directory</p>
</blockquote>
<p>Here is how varying the value of <code>MAX_LINES_PER_BATCH</code> environment variable can fluctuate the overall performance of the system.</p>
<p><img alt="max" src="images/max-variation.png" /></p>
<p>As highlighted above just setting the smallest value to <code>MAX_LINES_PER_BATCH</code> variable doesn't make the system to run automatically faster. As we have set <code>MaxConcurrency to zero</code> in the map state, AWS step function will try to provide maximum parallelism by running as many k8s jobs as possible in parallel. So all the k8s jobs will start competing for the same hardware resources (EKS worker nodes) which will make concurrency more a bottleneck rather than a value add. We can overcome this behavior by setting the right value to <code>MaxConcurrency</code> attribute and enabling autoscaling for EKS worker nodes. Scaling EKS worker are faster but they are not instantaneous so the whole scaling process by itself will definitely take sometime, eventually causing delays in the processing of workload.</p>
<p>So its definitely essential to run some experiments and decide on right values for both <code>MAX_LINES_PER_BATCH</code> environment variable and <code>MaxConcurrency</code> attribute in Map state</p>
<h2 id="cleanup">Cleanup<a class="headerlink" href="#cleanup" title="Permanent link">&para;</a></h2>
<p>Run the following command from the root directory to delete the stack</p>
<div class="highlight"><pre><span></span><code>cdk destroy
</code></pre></div>
<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://aws.amazon.com/step-functions">AWS Step functions</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/controllers/job/">Kubernetes jobs</a></li>
<li><a href="https://docs.aws.amazon.com/step-functions/latest/dg/connect-eks.html">Amazon EKS with Step function</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/efs-csi.html">CSI Driver EFS</a></li>
<li><a href="https://kb.iu.edu/d/afar">Unix split command</a></li>
<li><a href="https://redis.io/commands/set">Redis set commands</a></li>
</ul>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../aws-cdk-eks-multi-region-skeleton/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Multi Region EKS Clusters with CDK" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Multi Region EKS Clusters with CDK
            </div>
          </div>
        </a>
      
      
        
        <a href="../prefetch-data-to-eks-nodes/" class="md-footer__link md-footer__link--next" aria-label="Next: Prefetch Images to EKS nodes" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Prefetch Images to EKS nodes
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["tabs"], "search": "../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>